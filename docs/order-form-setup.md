# Настройка формы заказа оборудования

В этом руководстве описано, как настроить и использовать систему формы заказа с валидацией, ограничением отправки и обработкой персональных данных.

## Обзор функционала

Форма заказа включает в себя следующие возможности:

- Валидация формы на клиенте с использованием Zod
- Ограничение отправки формы (не более 3 раз в 24 часа)
- Поддержка согласия на обработку персональных данных
- Поддержка дополнительных полей (email, комментарий)
- Защита от спама через лимиты отправок

## Конфигурация

### Настройки лимитов отправки

Все настройки ограничения отправки форм находятся в `config.ts`:

```ts
rateLimit: {
  WINDOW_MS: 24 * 60 * 60 * 1000, // 24 часа (в миллисекундах)
  MAX_REQUESTS: 3, // Максимум 3 отправки в течение окна
  STORAGE_KEY: 'orderFormSubmissions', // Ключ для хранения данных в localStorage
  TIME_MESSAGE: (hours: number) => `Следующая отправка формы возможна через ${hours} часов` // Шаблон сообщения
}
```

### Настройки валидации

Настройки валидации находятся непосредственно в хуке `useOrderForm`:

```ts
const VALIDATION_CONFIG = {
  FULL_NAME: {
    MIN: 2, // Минимальная длина ФИО
    MAX: 100, // Максимальная длина ФИО
    PATTERN: /^[a-zA-Zа-яА-ЯёЁ\s\-']+$/u // Допустимые символы
  },
  PHONE: {
    MIN: 10, // Минимум 10 цифр
    MAX: 20, // Максимум 20 символов
    PATTERN: /^[\d\s\-\+\(\)]+$/, // Допустимые символы
    CLEAN_PATTERN: /[^\d+]/g // Паттерн для очистки номера
  },
  EMAIL: {
    MAX: 100 // Максимальная длина email
  },
  COMMENT: {
    MAX: 500 // Максимальная длина комментария
  }
}
```

## Использование хука useOrderForm

### Базовое использование

```tsx
import { useOrderForm } from '@/hooks/useOrderForm';

function MyOrderComponent() {
  const {
    formData,
    errors,
    loading,
    success,
    isRateLimited,
    timeUntilReset,
    handleChange,
    validateForm,
    submitOrder
  } = useOrderForm();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!isRateLimited && validateForm(true)) {
      const result = await submitOrder({}, true);
      
      if (result.success) {
        // Обработка успешной отправки
      }
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* Поля формы */}
    </form>
  );
}
```

### Параметры хука

Хук принимает следующие параметры:

```ts
interface UseOrderFormOptions {
  initialData?: Partial<OrderFormData>; // Начальные данные формы
  autoValidate?: boolean; // Автоматическая валидация при изменении
  enableRateLimit?: boolean; // Включить ограничение отправки
  onSuccess?: (data: OrderFormData) => void; // Коллбек при успешной отправке
  onError?: (error: string) => void; // Коллбек при ошибке
}
```

### Возвращаемые значения

Хук возвращает объект с следующими свойствами:

- `formData` - текущие данные формы
- `errors` - ошибки валидации
- `loading` - состояние загрузки
- `success` - состояние успешной отправки
- `isRateLimited` - признак ограничения на отправку
- `timeUntilReset` - время до снятия ограничения (в миллисекундах)
- `submissionsCount` - количество отправок в текущем окне
- `handleChange` - функция для изменения полей формы
- `validateForm` - функция валидации формы
- `submitOrder` - функция отправки формы

## Использование в компоненте OrderModal

Компонент `OrderModal` использует хук для отображения формы заказа с ограничением отправки:

```tsx
export default function OrderModal({ isOpen, onClose }: OrderModalProps) {
  const {
    formData,
    consent,
    errors,
    loading,
    success,
    isRateLimited,
    timeUntilReset,
    handleChange,
    handleConsentChange,
    validateForm,
    submitOrder,
    resetForm
  } = useOrderForm();

  // Функция обработки отправки
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!isRateLimited && validateForm(true)) {
      const result = await submitOrder({}, true);

      if (result.success) {
        setTimeout(() => {
          resetForm();
          onClose();
        }, 3000);
      }
    }
  };

  return (
    <div>
      {/* Содержимое модального окна */}
      {isRateLimited && timeUntilReset && (
        <div className="mt-4 text-center text-sm text-gray-600">
          {SITE_CONFIG.rateLimit.TIME_MESSAGE(Math.ceil(timeUntilReset / (1000 * 60 * 60)))}
        </div>
      )}
    </div>
  );
}
```

## Валидация данных

Форма использует Zod для валидации данных:

### Поля формы

- `fullName` - обязательное поле, минимум 2 символа, только буквы, пробелы, дефисы и апострофы
- `phone` - обязательное поле, минимум 10 цифр
- `email` - необязательное поле, валидный email адрес
- `comment` - необязательное поле, максимум 500 символов
- `consent` - обязательное поле при отправке с согласием

### Проверка согласия

При отправке с согласием проверяется, что пользователь подтвердил согласие на обработку персональных данных.

## Ограничение отправки формы

Система ограничения отправки форм работает следующим образом:

1. При отправке успешной формы записывается время отправки и увеличивается счетчик
2. В localStorage сохраняется объект с timestamp и count
3. При следующей попытке отправки проверяется:
   - Если прошло менее 24 часов с последней отправки
   - Если количество отправок в окне не превышает лимит
4. Если лимит превышен, отправка запрещается до истечения окна

### Управление лимитом

- Лимит настраивается в `config.ts` через `SITE_CONFIG.rateLimit`
- При необходимости лимит можно отключить через параметр `enableRateLimit: false`
- Лимит сбрасывается автоматически после окончания 24-часового окна

## Обработка ошибок

При возникновении ошибок:

- Пользователю показывается соответствующее сообщение
- Ошибки валидации отображаются под соответствующими полями
- При ошибках отправки вызывается коллбек `onError`
- При успешной отправке вызывается коллбек `onSuccess`

## Безопасность

1. Валидация данных на клиенте и сервере
2. Проверка согласия на обработку персональных данных
3. Ограничение частоты отправки форм
4. Защита от XSS через правильную обработку данных

## Устранение неполадок

### Проблемы с ограничением отправки

Если ограничение отправки не работает:
1. Проверьте, что `enableRateLimit` установлен в `true`
2. Убедитесь, что в localStorage записываются данные
3. Проверьте, что используется правильный ключ хранения

### Проблемы с валидацией

Если валидация не срабатывает:
1. Убедитесь, что используется правильный паттерн для ввода данных
2. Проверьте, что поля формы связаны с хуком через `handleChange`

### Проблемы с отправкой

Если форма не отправляется:
1. Проверьте, что все обязательные поля заполнены
2. Убедитесь, что согласие установлено (если требуется)
3. Проверьте, что лимит отправки не превышен
4. Убедитесь, что все валидации пройдены